<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>H5 ç‚¹åå·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4">
  <h1 class="text-xl font-bold text-center">ğŸ“‹ éšæœºç‚¹å</h1>

  <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
  <div id="authStatus" class="text-center text-sm">
    <span id="loginStatus" class="text-gray-500">æœªç™»å½•</span>
    <button id="authBtn" onclick="toggleAuth()" class="ml-2 text-blue-500 underline">ç™»å½•</button>
  </div>

  <!-- ç™»å½•è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
  <div id="loginForm" class="hidden space-y-2 p-4 bg-gray-50 rounded-lg">
    <input id="username" type="text" placeholder="è´¦å·" 
           class="w-full border rounded-lg p-2 text-sm" />
    <input id="password" type="password" placeholder="å¯†ç " 
           class="w-full border rounded-lg p-2 text-sm" />
    <button onclick="login()" 
            class="w-full bg-green-500 text-white py-2 rounded-lg active:scale-95 transition">
      ğŸ” ç™»å½•
    </button>
    <p id="loginError" class="text-red-500 text-xs text-center hidden"></p>
  </div>

  <!-- æ˜¾ç¤ºç»“æœ -->
  <div id="result"
       class="text-center text-3xl font-bold text-blue-600 h-16 flex items-center justify-center">
    â€”
  </div>

  <!-- ç‚¹åæŒ‰é’® -->
  <button onclick="pick()"
          class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg active:scale-95 transition">
    ğŸ¯ å¼€å§‹
  </button>

  <!-- æ‰¹é‡å½•å…¥ï¼ˆéœ€è¦ç™»å½•ï¼‰ -->
  <div id="editArea" class="space-y-2 opacity-50">
    <textarea id="input"
              class="w-full border rounded-lg p-2 text-sm"
              rows="4"
              placeholder="æ¯è¡Œä¸€ä¸ªåå­—ï¼ˆç›¸åŒåå­—ä¼šè¦†ç›–æ›´æ–°ï¼‰"></textarea>

    <button onclick="importNames()"
            class="w-full bg-gray-200 py-2 rounded-lg disabled:cursor-not-allowed">
      â• å¯¼å…¥åå•
    </button>
    <button onclick="clearAll()"
          class="w-full bg-red-500 text-white py-2 rounded-lg active:scale-95 transition disabled:opacity-50">
      ğŸ—‘ æ¸…ç©ºå…¨éƒ¨åå•
    </button>
  </div>

  <!-- åå•åˆ—è¡¨ -->
  <ul id="list" class="text-sm space-y-1"></ul>
</div>

<script>
const API = '/api'
const BASE = 0.4
let state = { users: [] }
let authToken = localStorage.getItem('auth_token') || ''

/* ---------- è®¤è¯ç›¸å…³ ---------- */

async function checkAuth() {
  if (!authToken) {
    updateAuthUI(false)
    return false
  }
  try {
    const res = await fetch('/api/check', {
      headers: { 'Authorization': `Bearer ${authToken}` }
    })
    const data = await res.json()
    updateAuthUI(data.loggedIn)
    return data.loggedIn
  } catch (e) {
    updateAuthUI(false)
    return false
  }
}

function updateAuthUI(loggedIn) {
  const loginStatus = document.getElementById('loginStatus')
  const authBtn = document.getElementById('authBtn')
  const editArea = document.getElementById('editArea')
  
  if (loggedIn) {
    loginStatus.textContent = 'å·²ç™»å½• âœ…'
    loginStatus.className = 'text-green-600'
    authBtn.textContent = 'é€€å‡º'
    editArea.classList.remove('opacity-50')
    document.getElementById('loginForm').classList.add('hidden')
  } else {
    loginStatus.textContent = 'æœªç™»å½•'
    loginStatus.className = 'text-gray-500'
    authBtn.textContent = 'ç™»å½•'
    editArea.classList.add('opacity-50')
  }
}

function toggleAuth() {
  if (authToken) {
    // é€€å‡ºç™»å½•
    authToken = ''
    localStorage.removeItem('auth_token')
    updateAuthUI(false)
  } else {
    // æ˜¾ç¤ºç™»å½•è¡¨å•
    document.getElementById('loginForm').classList.toggle('hidden')
  }
}

async function login() {
  const username = document.getElementById('username').value
  const password = document.getElementById('password').value
  const errorEl = document.getElementById('loginError')
  
  try {
    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
    const data = await res.json()
    
    if (data.success) {
      authToken = data.token
      localStorage.setItem('auth_token', authToken)
      updateAuthUI(true)
      errorEl.classList.add('hidden')
      document.getElementById('username').value = ''
      document.getElementById('password').value = ''
    } else {
      errorEl.textContent = data.message || 'ç™»å½•å¤±è´¥'
      errorEl.classList.remove('hidden')
    }
  } catch (e) {
    errorEl.textContent = 'ç½‘ç»œé”™è¯¯'
    errorEl.classList.remove('hidden')
  }
}

/* ---------- å·¥å…·å‡½æ•° ---------- */

function calcWeight(hitCount) {
  return Math.pow(BASE, hitCount)
}

function weightedPick(users) {
  const pool = users.filter(u => !u.disabled)
  const total = pool.reduce((s, u) => s + u.weight, 0)
  let r = Math.random() * total
  for (const u of pool) {
    if (r < u.weight) return u
    r -= u.weight
  }
}

/* ---------- æ•°æ®åŒæ­¥ ---------- */

async function load() {
  // 1. ä¼˜å…ˆå°è¯•ä»æœ¬åœ° localStorage è¯»å–
  const localData = localStorage.getItem('pick_user_data');
  if (localData) {
    state = JSON.parse(localData);
    console.log('ä»æœ¬åœ°ç¼“å­˜åŠ è½½æˆåŠŸ');
    render();
  }

  // 2. æ— è®ºæœ¬åœ°æ˜¯å¦æœ‰ï¼Œéƒ½å°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®ä»¥ä¿æŒåŒæ­¥
  try {
    const res = await fetch(API);
    if (res.ok) {
      const serverData = await res.json();
      if (serverData && serverData.users && serverData.users.length > 0) {
        state = serverData;
        localStorage.setItem('pick_user_data', JSON.stringify(state));
        render();
        console.log('ä»æœåŠ¡å™¨åŒæ­¥å®Œæˆ');
      }
    }
  } catch (e) {
    console.warn('è¿œç¨‹åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°ç¦»çº¿æ•°æ®:', e);
  }
}

async function sync() {
  // 1. ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
  localStorage.setItem('pick_user_data', JSON.stringify(state));

  // 2. å¼‚æ­¥å‘é€åˆ°æœåŠ¡å™¨å¤‡ä»½ï¼ˆéœ€è¦ç™»å½•ï¼‰
  if (!authToken) {
    console.warn('æœªç™»å½•ï¼Œæ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°');
    return;
  }
  
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(state)
    });
    
    if (res.status === 401) {
      alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
      authToken = '';
      localStorage.removeItem('auth_token');
      updateAuthUI(false);
      return;
    }
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    console.log('è¿œç¨‹å¤‡ä»½æˆåŠŸ');
  } catch (e) {
    console.error('è¿œç¨‹åŒæ­¥å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åœ¨æœ¬åœ°:', e);
  }
}

/* ---------- ä¸šåŠ¡é€»è¾‘ ---------- */

function importNames() {
  if (!authToken) {
    alert('è¯·å…ˆç™»å½•åå†å¯¼å…¥åå•');
    return;
  }
  
  const lines = input.value.split('\n').map(s => s.trim()).filter(Boolean)

  lines.forEach(line => {
    const [name, count] = line.split(/[,ï¼Œ]/)
    const trimmedName = name.trim()
    const hitCount = Number(count) || 0
    
    // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°
    const existingIndex = state.users.findIndex(u => u.name === trimmedName)
    
    if (existingIndex >= 0) {
      // è¦†ç›–æ›´æ–°å·²å­˜åœ¨çš„ç”¨æˆ·
      state.users[existingIndex].hitCount = hitCount
      state.users[existingIndex].weight = calcWeight(hitCount)
    } else {
      // æ·»åŠ æ–°ç”¨æˆ·
      state.users.push({
        id: crypto.randomUUID(),
        name: trimmedName,
        hitCount,
        weight: calcWeight(hitCount),
        disabled: false
      })
    }
  })

  input.value = ''
  sync()
  render()
}

function pick() {
  if (!state.users.length) return
  const user = weightedPick(state.users)
  if (!user) return

  user.hitCount++
  user.weight = calcWeight(user.hitCount)

  result.textContent = user.name
  // ç‚¹åä¸éœ€è¦ç™»å½•ï¼Œåªä¿å­˜æœ¬åœ°
  localStorage.setItem('pick_user_data', JSON.stringify(state));
  render()
}

function removeUser(id) {
  if (!authToken) {
    alert('è¯·å…ˆç™»å½•åå†åˆ é™¤');
    return;
  }
  if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªäººå—ï¼Ÿ')) return
  state.users = state.users.filter(u => u.id !== id)
  sync()
  render()
}

function clearAll() {
  if (!authToken) {
    alert('è¯·å…ˆç™»å½•åå†æ¸…ç©º');
    return;
  }
  if (!confirm('ç¡®å®šè¦åˆ é™¤å…¨éƒ¨åå•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) return
  state.users = []
  result.textContent = 'â€”'
  sync()
  render()
}

/* ---------- UI ---------- */

function render() {
  const isLoggedIn = !!authToken
  list.innerHTML = ''
  state.users.forEach(u => {
    const li = document.createElement('li')
    li.className = 'flex justify-between items-center text-gray-700'

    li.innerHTML = `
      <span>${u.name}</span>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400">
          ${u.hitCount}æ¬¡
        </span>
        ${isLoggedIn ? `
        <button
          onclick="removeUser('${u.id}')"
          class="text-red-500 text-sm active:scale-90">
          âŒ
        </button>
        ` : ''}
      </div>
    `
    list.appendChild(li)
  })
}

/* ---------- å¯åŠ¨ ---------- */
checkAuth()
load()
</script>

</body>
</html>
