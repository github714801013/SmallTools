<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H5 æŠ½æŸ¥å·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4">
    <h1 class="text-xl font-bold text-center">ğŸ“‹ éšæœºæŠ½æŸ¥</h1>

    <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
    <div id="authStatus" class="text-center text-sm">
      <span id="loginStatus" class="text-gray-500">æœªç™»å½•</span>
      <button id="authBtn" onclick="toggleAuth()" class="ml-2 text-blue-500 underline">ç™»å½•</button>
    </div>

    <!-- ç™»å½•è¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="loginForm" class="hidden space-y-2 p-4 bg-gray-50 rounded-lg">
      <input id="username" type="text" placeholder="è´¦å·" class="w-full border rounded-lg p-2 text-sm" />
      <input id="password" type="password" placeholder="å¯†ç " class="w-full border rounded-lg p-2 text-sm" />
      <button onclick="login()" class="w-full bg-green-500 text-white py-2 rounded-lg active:scale-95 transition">
        ğŸ” ç™»å½•
      </button>
      <p id="loginError" class="text-red-500 text-xs text-center hidden"></p>
    </div>

    <!-- æ˜¾ç¤ºç»“æœ -->
    <div id="result" class="text-center text-3xl font-bold text-blue-600 h-16 flex items-center justify-center">
      â€”
    </div>

    <!-- æŠ½æŸ¥æŒ‰é’® -->
    <button onclick="pick()" class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg active:scale-95 transition">
      ğŸ¯ å¼€å§‹æŠ½æŸ¥
    </button>

    <!-- æ‰¹é‡å½•å…¥ï¼ˆéœ€è¦ç™»å½•ï¼‰ -->
    <div id="editArea" class="space-y-2 opacity-50">
      <textarea id="input" class="w-full border rounded-lg p-2 text-sm" rows="4"
        placeholder="æ¯è¡Œä¸€ä¸ªåå­—ï¼ˆç›¸åŒåå­—ä¼šè¦†ç›–æ›´æ–°ï¼‰"></textarea>
    </div>

    <!-- ä¼ä¸šå¾®ä¿¡æ¨é€ï¼ˆç‹¬ç«‹åŒºåŸŸï¼Œå·²é…ç½®æ—¶å§‹ç»ˆæ˜¾ç¤ºå¼€å…³ï¼‰ -->
    <div id="webhookArea" class="hidden">
      <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
        <div class="flex items-center gap-2">
          <span class="text-sm text-green-700">ğŸ“¢ æ¨é€</span>
          <span id="webhookStatus" class="text-xs text-green-600"></span>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="notifyToggle" class="sr-only peer" onchange="toggleNotify()">
          <div
            class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500">
          </div>
        </label>
      </div>
      <!-- é…ç½®åŒºåŸŸï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼‰ -->
      <div id="webhookConfig" class="hidden mt-2 p-2 bg-gray-50 rounded-lg space-y-2">
        <div class="flex gap-2">
          <input id="webhookKeyInput" type="text" placeholder="Webhookå¯†é’¥" class="flex-1 border rounded p-1.5 text-xs" />
          <button onclick="saveWebhookKey()" class="px-3 bg-green-500 text-white rounded text-xs">ä¿å­˜</button>
          <button onclick="clearWebhookKey()" class="px-2 bg-gray-300 text-gray-600 rounded text-xs">æ¸…</button>
        </div>
      </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæŒ‰é’®ï¼ˆéœ€è¦ç™»å½•ï¼‰ -->
    <div id="editBtns" class="space-y-2 opacity-50">
      <button onclick="importNames()" class="w-full bg-gray-200 py-2 rounded-lg disabled:cursor-not-allowed">
        â• å¯¼å…¥åå•
      </button>
      <button onclick="clearAll()"
        class="w-full bg-red-500 text-white py-2 rounded-lg active:scale-95 transition disabled:opacity-50">
        ğŸ—‘ æ¸…ç©ºå…¨éƒ¨åå•
      </button>
    </div>

    <!-- å½“æ¬¡æŠ½æŸ¥å†å² -->
    <div class="space-y-2">
      <div class="flex justify-between items-center">
        <span class="text-sm font-medium text-gray-600">ğŸ“ æœ¬æ¬¡æŠ½æŸ¥è®°å½•</span>
        <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500">æ¸…ç©º</button>
      </div>
      <div id="pickHistory"
        class="text-sm text-gray-500 bg-gray-50 rounded-lg p-2 min-h-[40px] max-h-[100px] overflow-y-auto">
        <span class="text-gray-400">æš‚æ— è®°å½•</span>
      </div>
    </div>

    <!-- åå•åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰ -->
    <div class="space-y-1">
      <button onclick="toggleList()" class="flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700">
        <span id="listToggleIcon">â–¶</span>
        <span>å¾…æŠ½æŸ¥åå• (<span id="listCount">0</span>äºº)</span>
      </button>
      <ul id="list" class="text-sm space-y-1 hidden"></ul>
    </div>
  </div>

  <script>
    const API = '/api'
    const BASE = 0.4
    let state = { users: [] }
    let pickHistory = []  // å½“æ¬¡æŠ½æŸ¥å†å²
    let authToken = localStorage.getItem('auth_token') || ''
    let notifyEnabled = localStorage.getItem('notify_enabled') === 'true'  // æ¨é€å¼€å…³

    /* ---------- è®¤è¯ç›¸å…³ ---------- */

    async function checkAuth() {
      if (!authToken) {
        updateAuthUI(false)
        return false
      }
      try {
        const res = await fetch('/api/check', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        })
        const data = await res.json()
        updateAuthUI(data.loggedIn)
        return data.loggedIn
      } catch (e) {
        updateAuthUI(false)
        return false
      }
    }

    function updateAuthUI(loggedIn) {
      const loginStatus = document.getElementById('loginStatus')
      const authBtn = document.getElementById('authBtn')
      const editArea = document.getElementById('editArea')
      const editBtns = document.getElementById('editBtns')
      const webhookConfig = document.getElementById('webhookConfig')

      if (loggedIn) {
        loginStatus.textContent = 'å·²ç™»å½• âœ…'
        loginStatus.className = 'text-green-600'
        authBtn.textContent = 'é€€å‡º'
        editArea.classList.remove('hidden')
        editBtns.classList.remove('hidden')
        editBtns.classList.remove('opacity-50')
        webhookConfig.classList.remove('hidden')
        document.getElementById('loginForm').classList.add('hidden')
        checkWebhookStatus()
      } else {
        loginStatus.textContent = 'æœªç™»å½•'
        loginStatus.className = 'text-gray-500'
        authBtn.textContent = 'ç™»å½•'
        editArea.classList.add('hidden')
        editBtns.classList.add('hidden')
        webhookConfig.classList.add('hidden')
        // æœªç™»å½•æ—¶ä¹Ÿæ£€æŸ¥æ¨é€çŠ¶æ€ï¼Œå·²é…ç½®åˆ™æ˜¾ç¤ºå¼€å…³
        checkWebhookStatus()
      }
    }

    function toggleAuth() {
      if (authToken) {
        // é€€å‡ºç™»å½•
        authToken = ''
        localStorage.removeItem('auth_token')
        updateAuthUI(false)
      } else {
        // æ˜¾ç¤ºç™»å½•è¡¨å•
        document.getElementById('loginForm').classList.toggle('hidden')
      }
    }

    async function login() {
      const username = document.getElementById('username').value
      const password = document.getElementById('password').value
      const errorEl = document.getElementById('loginError')

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        })
        const data = await res.json()

        if (data.success) {
          authToken = data.token
          localStorage.setItem('auth_token', authToken)
          updateAuthUI(true)
          errorEl.classList.add('hidden')
          document.getElementById('username').value = ''
          document.getElementById('password').value = ''
        } else {
          errorEl.textContent = data.message || 'ç™»å½•å¤±è´¥'
          errorEl.classList.remove('hidden')
        }
      } catch (e) {
        errorEl.textContent = 'ç½‘ç»œé”™è¯¯'
        errorEl.classList.remove('hidden')
      }
    }

    /* ---------- ä¼ä¸šå¾®ä¿¡æ¨é€ç›¸å…³ ---------- */

    async function checkWebhookStatus() {
      try {
        const res = await fetch('/api/webhook/status')
        const data = await res.json()
        const webhookArea = document.getElementById('webhookArea')
        const statusEl = document.getElementById('webhookStatus')
        const toggleEl = document.getElementById('notifyToggle')

        if (data.configured) {
          // å·²é…ç½®ï¼šå§‹ç»ˆæ˜¾ç¤ºæ¨é€åŒºåŸŸï¼ˆå¼€å…³ï¼‰
          webhookArea.classList.remove('hidden')
          statusEl.textContent = `å·²é…ç½®`
          // å·²é…ç½®æ—¶é»˜è®¤å¯ç”¨ï¼ˆé™¤éç”¨æˆ·æ˜ç¡®å…³é—­è¿‡ï¼‰
          if (localStorage.getItem('notify_enabled') === null) {
            notifyEnabled = true
            localStorage.setItem('notify_enabled', 'true')
          }
          toggleEl.checked = notifyEnabled
        } else {
          // æœªé…ç½®
          statusEl.textContent = 'æœªé…ç½®'
          toggleEl.checked = false
          notifyEnabled = false
          // æœªç™»å½•ä¸”æœªé…ç½®æ—¶éšè—æ•´ä¸ªåŒºåŸŸ
          if (!authToken) {
            webhookArea.classList.add('hidden')
          } else {
            webhookArea.classList.remove('hidden')
          }
        }
      } catch (e) {
        console.warn('è·å–WebhookçŠ¶æ€å¤±è´¥:', e)
      }
    }

    function toggleNotify() {
      notifyEnabled = document.getElementById('notifyToggle').checked
      localStorage.setItem('notify_enabled', notifyEnabled)
    }

    async function saveWebhookKey() {
      const keyInput = document.getElementById('webhookKeyInput')
      const key = keyInput.value.trim()
      if (!key) {
        alert('è¯·è¾“å…¥Webhookå¯†é’¥')
        return
      }

      try {
        const res = await fetch('/api/webhook/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ webhookKey: key })
        })
        const data = await res.json()
        if (data.success) {
          alert('ä¿å­˜æˆåŠŸ')
          keyInput.value = ''
          checkWebhookStatus()
        } else {
          alert(data.message || 'ä¿å­˜å¤±è´¥')
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯')
      }
    }

    async function clearWebhookKey() {
      if (!confirm('ç¡®å®šæ¸…é™¤Webhooké…ç½®å—ï¼Ÿ')) return

      try {
        const res = await fetch('/api/webhook/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ webhookKey: null })
        })
        const data = await res.json()
        if (data.success) {
          alert('å·²æ¸…é™¤')
          checkWebhookStatus()
        }
      } catch (e) {
        alert('ç½‘ç»œé”™è¯¯')
      }
    }

    async function sendNotify(name, time) {
      if (!notifyEnabled) return

      try {
        await fetch('/api/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, time })
        })
      } catch (e) {
        console.warn('æ¨é€å¤±è´¥:', e)
      }
    }

    /* ---------- å·¥å…·å‡½æ•° ---------- */

    function calcWeight(hitCount) {
      return Math.pow(BASE, hitCount)
    }

    function weightedPick(users) {
      const pool = users.filter(u => !u.disabled)
      const total = pool.reduce((s, u) => s + u.weight, 0)
      let r = Math.random() * total
      for (const u of pool) {
        if (r < u.weight) return u
        r -= u.weight
      }
    }

    /* ---------- æ•°æ®åŒæ­¥ ---------- */

    async function load() {
      // 1. ä¼˜å…ˆå°è¯•ä»æœ¬åœ° localStorage è¯»å–
      const localData = localStorage.getItem('pick_user_data');
      if (localData) {
        state = JSON.parse(localData);
        console.log('ä»æœ¬åœ°ç¼“å­˜åŠ è½½æˆåŠŸ');
        render();
      }

      // 2. æ— è®ºæœ¬åœ°æ˜¯å¦æœ‰ï¼Œéƒ½å°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®ä»¥ä¿æŒåŒæ­¥
      try {
        const res = await fetch(API);
        if (res.ok) {
          const serverData = await res.json();
          if (serverData && serverData.users && serverData.users.length > 0) {
            state = serverData;
            localStorage.setItem('pick_user_data', JSON.stringify(state));
            render();
            console.log('ä»æœåŠ¡å™¨åŒæ­¥å®Œæˆ');
          }
        }
      } catch (e) {
        console.warn('è¿œç¨‹åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°ç¦»çº¿æ•°æ®:', e);
      }
    }

    async function sync() {
      // 1. ç«‹å³ä¿å­˜åˆ°æœ¬åœ°
      localStorage.setItem('pick_user_data', JSON.stringify(state));

      // 2. å¼‚æ­¥å‘é€åˆ°æœåŠ¡å™¨å¤‡ä»½ï¼ˆéœ€è¦ç™»å½•ï¼‰
      if (!authToken) {
        console.warn('æœªç™»å½•ï¼Œæ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°');
        return;
      }

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify(state)
        });

        if (res.status === 401) {
          alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
          authToken = '';
          localStorage.removeItem('auth_token');
          updateAuthUI(false);
          return;
        }

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        console.log('è¿œç¨‹å¤‡ä»½æˆåŠŸ');
      } catch (e) {
        console.error('è¿œç¨‹åŒæ­¥å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åœ¨æœ¬åœ°:', e);
      }
    }

    /* ---------- ä¸šåŠ¡é€»è¾‘ ---------- */

    function importNames() {
      if (!authToken) {
        alert('è¯·å…ˆç™»å½•åå†å¯¼å…¥åå•');
        return;
      }

      const lines = input.value.split('\n').map(s => s.trim()).filter(Boolean)

      lines.forEach(line => {
        const [name, count] = line.split(/[,ï¼Œ]/)
        const trimmedName = name.trim()
        const hitCount = Number(count) || 0

        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç§°
        const existingIndex = state.users.findIndex(u => u.name === trimmedName)

        if (existingIndex >= 0) {
          // è¦†ç›–æ›´æ–°å·²å­˜åœ¨çš„ç”¨æˆ·
          state.users[existingIndex].hitCount = hitCount
          state.users[existingIndex].weight = calcWeight(hitCount)
        } else {
          // æ·»åŠ æ–°ç”¨æˆ·
          state.users.push({
            id: crypto.randomUUID(),
            name: trimmedName,
            hitCount,
            weight: calcWeight(hitCount),
            disabled: false
          })
        }
      })

      input.value = ''
      sync()
      render()
    }

    function pick() {
      if (!authToken) {
        alert('è¯·å…ˆç™»å½•åå†æŠ½æŸ¥')
        return
      }
      if (!state.users.length) return
      const user = weightedPick(state.users)
      if (!user) return

      user.hitCount++
      user.weight = calcWeight(user.hitCount)

      // è®°å½•åˆ°å½“æ¬¡å†å²
      const now = new Date()
      const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
      pickHistory.push({ name: user.name, time: timeStr })

      result.textContent = user.name
      // ç‚¹åä¸éœ€è¦ç™»å½•ï¼Œåªä¿å­˜æœ¬åœ°
      localStorage.setItem('pick_user_data', JSON.stringify(state));
      render()
      renderHistory()
      // å‘é€ä¼ä¸šå¾®ä¿¡æ¨é€
      sendNotify(user.name, timeStr)
    }

    function clearHistory() {
      pickHistory = []
      renderHistory()
    }

    function renderHistory() {
      const historyEl = document.getElementById('pickHistory')
      if (pickHistory.length === 0) {
        historyEl.innerHTML = '<span class="text-gray-400">æš‚æ— è®°å½•</span>'
      } else {
        historyEl.innerHTML = pickHistory
          .map((h, i) => `<span class="inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded mr-1 mb-1">${i + 1}. ${h.name} <span class="text-xs text-blue-400">${h.time}</span></span>`)
          .join('')
      }
    }

    function removeUser(id) {
      if (!authToken) {
        alert('è¯·å…ˆç™»å½•åå†åˆ é™¤');
        return;
      }
      if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªäººå—ï¼Ÿ')) return
      state.users = state.users.filter(u => u.id !== id)
      sync()
      render()
    }

    function clearAll() {
      if (!authToken) {
        alert('è¯·å…ˆç™»å½•åå†æ¸…ç©º');
        return;
      }
      if (!confirm('ç¡®å®šè¦åˆ é™¤å…¨éƒ¨åå•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) return
      state.users = []
      result.textContent = 'â€”'
      sync()
      render()
    }

    /* ---------- UI ---------- */

    function toggleList() {
      const listEl = document.getElementById('list')
      const iconEl = document.getElementById('listToggleIcon')
      if (listEl.classList.contains('hidden')) {
        listEl.classList.remove('hidden')
        iconEl.textContent = 'â–¼'
      } else {
        listEl.classList.add('hidden')
        iconEl.textContent = 'â–¶'
      }
    }

    function render() {
      const isLoggedIn = !!authToken
      const listEl = document.getElementById('list')
      listEl.innerHTML = ''

      // æ›´æ–°äººæ•°æ˜¾ç¤º
      document.getElementById('listCount').textContent = state.users.length

      state.users.forEach(u => {
        const li = document.createElement('li')
        li.className = 'flex justify-between items-center text-gray-700'

        li.innerHTML = `
      <span>${u.name}</span>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400">
          ${u.hitCount}æ¬¡
        </span>
        ${isLoggedIn ? `
        <button
          onclick="removeUser('${u.id}')"
          class="text-red-500 text-sm active:scale-90">
          âŒ
        </button>
        ` : ''}
      </div>
    `
        listEl.appendChild(li)
      })
    }

    /* ---------- å¯åŠ¨ ---------- */
    checkAuth()
    load()
  </script>

</body>

</html>