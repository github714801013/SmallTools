<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>H5 ç‚¹åå·¥å…·</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4">
  <h1 class="text-xl font-bold text-center">ğŸ“‹ éšæœºç‚¹å</h1>

  <!-- æ˜¾ç¤ºç»“æœ -->
  <div id="result"
       class="text-center text-3xl font-bold text-blue-600 h-16 flex items-center justify-center">
    â€”
  </div>

  <!-- ç‚¹åæŒ‰é’® -->
  <button onclick="pick()"
          class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg active:scale-95 transition">
    ğŸ¯ å¼€å§‹
  </button>

  <!-- æ‰¹é‡å½•å…¥ -->
  <textarea id="input"
            class="w-full border rounded-lg p-2 text-sm"
            rows="4"
            placeholder="æ¯è¡Œä¸€ä¸ªåå­—"></textarea>

  <button onclick="importNames()"
          class="w-full bg-gray-200 py-2 rounded-lg">
    â• å¯¼å…¥åå•
  </button>
  <button onclick="clearAll()"
        class="w-full bg-red-500 text-white py-2 rounded-lg active:scale-95 transition">
  ğŸ—‘ æ¸…ç©ºå…¨éƒ¨åå•
  </button>


  <!-- åå•åˆ—è¡¨ -->
  <ul id="list" class="text-sm space-y-1"></ul>
</div>

<script>
const API = '/api'
const BASE = 0.4
let state = {
  users: []
}

/* ---------- å·¥å…·å‡½æ•° ---------- */

function calcWeight(hitCount) {
  return Math.pow(BASE, hitCount)
}

function weightedPick(users) {
  const pool = users.filter(u => !u.disabled)
  const total = pool.reduce((s, u) => s + u.weight, 0)
  let r = Math.random() * total
  for (const u of pool) {
    if (r < u.weight) return u
    r -= u.weight
  }
}

/* ---------- æ•°æ®åŒæ­¥ ---------- */

/* ---------- å¢å¼ºç‰ˆæ•°æ®åŒæ­¥é€»è¾‘ ---------- */

async function load() {
  // 1. ä¼˜å…ˆå°è¯•ä»æœ¬åœ° localStorage è¯»å–
  const localData = localStorage.getItem('pick_user_data');
  if (localData) {
    state = JSON.parse(localData);
    console.log('ä»æœ¬åœ°ç¼“å­˜åŠ è½½æˆåŠŸ');
    render();
  }

  // 2. æ— è®ºæœ¬åœ°æ˜¯å¦æœ‰ï¼Œéƒ½å°è¯•ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®ä»¥ä¿æŒåŒæ­¥
  try {
    const res = await fetch(API);
    if (res.ok) {
      const serverData = await res.json();
      // å¦‚æœæœåŠ¡å™¨æœ‰æ•°æ®ä¸”ä¸æœ¬åœ°ä¸åŒï¼ˆå¯æ ¹æ®éœ€è¦å¢åŠ æ›´å¤æ‚çš„å¯¹æ¯”é€»è¾‘ï¼‰
      if (serverData && serverData.users && serverData.users.length > 0) {
        state = serverData;
        localStorage.setItem('pick_user_data', JSON.stringify(state)); // åŒæ­¥åˆ°æœ¬åœ°
        render();
        console.log('ä»æœåŠ¡å™¨åŒæ­¥å®Œæˆ');
      }
    }
  } catch (e) {
    console.warn('è¿œç¨‹åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°ç¦»çº¿æ•°æ®:', e);
  }
}

async function sync() {
  // 1. ç«‹å³ä¿å­˜åˆ°æœ¬åœ°ï¼Œç¡®ä¿å“åº”é€Ÿåº¦
  localStorage.setItem('pick_user_data', JSON.stringify(state));

  // 2. å¼‚æ­¥å‘é€åˆ°æœåŠ¡å™¨å¤‡ä»½
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(state)
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    console.log('è¿œç¨‹å¤‡ä»½æˆåŠŸ');
  } catch (e) {
    console.error('è¿œç¨‹åŒæ­¥å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åœ¨æœ¬åœ°:', e);
    // è¿™é‡Œå¯ä»¥å¢åŠ ä¸€ä¸ª UI æç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·å½“å‰å¤„äºç¦»çº¿çŠ¶æ€
  }
}

/* ---------- ä¸šåŠ¡é€»è¾‘ ---------- */

function importNames() {
  const lines = input.value.split('\n').map(s => s.trim()).filter(Boolean)

  lines.forEach(line => {
    const [name, count] = line.split(/[,ï¼Œ]/)
    const hitCount = Number(count) || 0

    state.users.push({
      id: crypto.randomUUID(),
      name: name.trim(),
      hitCount,
      weight: calcWeight(hitCount),
      disabled: false
    })
  })

  input.value = ''
  sync()
  render()
}


function pick() {
  if (!state.users.length) return
  const user = weightedPick(state.users)
  if (!user) return

  user.hitCount++
  user.weight = calcWeight(user.hitCount)

  result.textContent = user.name
  sync()
  render()
}

function removeUser(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªäººå—ï¼Ÿ')) return
  state.users = state.users.filter(u => u.id !== id)
  sync()
  render()
}

function clearAll() {
  if (!confirm('ç¡®å®šè¦åˆ é™¤å…¨éƒ¨åå•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) return
  state.users = []
  result.textContent = 'â€”'
  sync()
  render()
}


/* ---------- UI ---------- */

function render() {
  list.innerHTML = ''
  state.users.forEach(u => {
    const li = document.createElement('li')
    li.className = 'flex justify-between items-center text-gray-700'

    li.innerHTML = `
      <span>${u.name}</span>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-400">
          ${u.hitCount}æ¬¡
        </span>
        <button
          onclick="removeUser('${u.id}')"
          class="text-red-500 text-sm active:scale-90">
          âŒ
        </button>
      </div>
    `
    list.appendChild(li)
  })
}

/* ---------- å¯åŠ¨ ---------- */
load()
</script>

</body>
</html>
